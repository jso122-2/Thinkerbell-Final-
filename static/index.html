<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thinkerbell - Enhanced Legal Text Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8fffe 50%, #f0fff4 100%);
            color: #1a202c;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);
            color: #f7fafc;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 20, 147, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 105, 180, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(254, 255, 150, 0.04) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(118, 197, 157, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            transition: all 0.3s ease;
        }

        body.dark-mode::before {
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 20, 147, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 105, 180, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(254, 255, 150, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(118, 197, 157, 0.06) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ff1493;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dark-mode-toggle:hover {
            background: rgba(255, 20, 147, 0.1);
            transform: scale(1.05);
        }

        body.dark-mode .dark-mode-toggle {
            background: rgba(45, 55, 72, 0.9);
            color: #f7fafc;
            border-color: #ff69b4;
        }

        body.dark-mode .dark-mode-toggle:hover {
            background: rgba(255, 105, 180, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
        }

        .logo {
            font-size: 4rem;
            font-weight: 900;
            color: #ff1493;
            margin-bottom: 10px;
            letter-spacing: -0.03em;
            position: relative;
            text-transform: lowercase;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: #ff69b4;
            border-radius: 2px;
        }

        .tagline {
            font-size: 1.1rem;
            font-weight: 400;
            color: #76c59d;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .subtitle {
            font-size: 1.3rem;
            color: #2d3748;
            margin-bottom: 40px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.7;
            font-weight: 500;
            letter-spacing: 0.025em;
        }

        body.dark-mode .subtitle {
            color: #e2e8f0;
        }

        .subtitle strong {
            color: #ff1493;
            font-weight: 700;
        }

        .credentials {
            font-size: 0.95rem;
            color: #2d3748;
            margin-top: 20px;
            padding: 15px 25px;
            background: rgba(255, 105, 180, 0.1);
            border-radius: 8px;
            border-left: 3px solid #ff69b4;
            display: inline-block;
        }

        body.dark-mode .credentials {
            color: #cbd5e0;
            background: rgba(255, 105, 180, 0.2);
        }

        .credentials strong {
            color: #ff1493;
            font-weight: 600;
        }

        /* Enhanced Menu System */
        .main-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .main-menu {
            background: rgba(45, 55, 72, 0.95);
            border-color: rgba(255, 105, 180, 0.2);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .menu-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .menu-card {
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.9) 0%, rgba(55, 65, 81, 0.9) 100%);
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff1493, #ff69b4, #feff96, #76c59d);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .menu-card:hover::before {
            transform: translateX(0);
        }

        .menu-card:hover {
            transform: translateY(-8px);
            border-color: rgba(255, 20, 147, 0.3);
            box-shadow: 0 20px 60px rgba(255, 20, 147, 0.2);
        }

        .menu-card.single {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .menu-card.single:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 20px 60px rgba(59, 130, 246, 0.2);
        }

        .menu-card.batch {
            border-color: rgba(255, 107, 107, 0.3);
        }

        .menu-card.batch:hover {
            border-color: rgba(255, 107, 107, 0.5);
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.2);
        }

        .menu-card.test {
            border-color: rgba(0, 255, 127, 0.3);
        }

        .menu-card.test:hover {
            border-color: rgba(0, 255, 127, 0.5);
            box-shadow: 0 20px 60px rgba(0, 255, 127, 0.2);
        }

        .menu-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .menu-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        body.dark-mode .menu-title {
            color: #e2e8f0;
        }

        .menu-description {
            font-size: 0.95rem;
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        body.dark-mode .menu-description {
            color: #94a3b8;
        }

        .menu-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            font-size: 0.85rem;
            color: #64748b;
        }

        body.dark-mode .menu-features {
            color: #94a3b8;
        }

        .menu-features li {
            margin: 5px 0;
            padding-left: 15px;
            position: relative;
        }

        .menu-features li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .menu-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff1493, #ff69b4);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
        }

        .menu-badge.new {
            background: linear-gradient(45deg, #10b981, #059669);
        }

        .menu-badge.popular {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        }

        .menu-badge.advanced {
            background: linear-gradient(45deg, #8b5cf6, #7c3aed);
        }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(118, 197, 157, 0.3);
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .quick-action-btn {
            background: rgba(45, 55, 72, 0.8);
            border-color: rgba(255, 105, 180, 0.3);
            color: #cbd5e0;
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ff1493;
            color: #ff1493;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 20, 147, 0.2);
        }

        body.dark-mode .quick-action-btn:hover {
            background: rgba(55, 65, 81, 0.95);
            border-color: #ff69b4;
            color: #ff69b4;
        }

        /* Status Indicators */
        .feature-status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #64748b;
        }

        body.dark-mode .status-item {
            background: rgba(45, 55, 72, 0.7);
            color: #94a3b8;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.warning {
            background: #f59e0b;
        }

        .status-dot.error {
            background: #ef4444;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-btn {
            background: #374151;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #4b5563;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(118, 197, 157, 0.2);
            border-radius: 12px;
            padding: 40px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(118, 197, 157, 0.1);
            position: relative;
        }

        body.dark-mode .card {
            background: rgba(45, 55, 72, 0.95);
            border-color: rgba(255, 105, 180, 0.3);
            box-shadow: 0 4px 20px rgba(255, 20, 147, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #ff69b4;
            border-radius: 12px 12px 0 0;
        }

        .card:hover {
            border-color: rgba(255, 20, 147, 0.6);
            background: rgba(255, 255, 255, 0.98);
            transform: translateY(-2px);
        }

        body.dark-mode .card:hover {
            background: rgba(55, 65, 81, 0.98);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        body.dark-mode .form-label {
            color: #e2e8f0;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(118, 197, 157, 0.3);
            border-radius: 8px;
            color: #1a202c;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        body.dark-mode .form-input,
        body.dark-mode .form-textarea,
        body.dark-mode .form-select {
            background: rgba(45, 55, 72, 0.9);
            border-color: rgba(255, 105, 180, 0.4);
            color: #f7fafc;
        }

        .form-textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }

        /* Optimized Human Example Textarea */
        #humanExample {
            min-height: 300px;
            max-height: 500px;
            resize: both;
            font-size: 15px;
            line-height: 1.6;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(118, 197, 157, 0.4);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        body.dark-mode #humanExample {
            background: rgba(45, 55, 72, 0.95);
            border-color: rgba(255, 105, 180, 0.5);
            color: #f7fafc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #humanExample:focus {
            outline: none;
            border-color: #ff1493;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 0 3px rgba(255, 20, 147, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        body.dark-mode #humanExample:focus {
            background: rgba(55, 65, 81, 0.98);
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.25), 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Enhanced container for human example */
        .human-example-container {
            position: relative;
            margin: 20px 0;
        }

        .human-example-container .cache-history-container {
            width: 100%;
        }

        /* Improved textarea label */
        .human-example-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .human-example-label {
            color: #e2e8f0;
        }

        .human-example-label::before {
            content: '✍️';
            font-size: 1.2rem;
        }

        /* Character/word count styling */
        .textarea-stats {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(118, 197, 157, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            color: #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(118, 197, 157, 0.2);
        }

        body.dark-mode .textarea-stats {
            background: rgba(255, 105, 180, 0.15);
            border-color: rgba(255, 105, 180, 0.3);
            color: #cbd5e0;
        }

        .textarea-stats .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .textarea-stats .stat-item::before {
            content: '📊';
            font-size: 0.8rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #humanExample {
                min-height: 250px;
                font-size: 14px;
                padding: 16px;
            }
            
            .textarea-stats {
                flex-direction: column;
                gap: 4px;
                text-align: center;
            }
        }

        @media (min-width: 1200px) {
            #humanExample {
                min-height: 350px;
                font-size: 16px;
            }
        }

        /* Detected Variables Styling */
        .detected-variables {
            margin: 15px 0;
            padding: 16px;
            background: rgba(59, 130, 246, 0.05);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        body.dark-mode .detected-variables {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .variables-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .variables-title {
            font-weight: 700;
            color: #1e40af;
            font-size: 1rem;
        }

        body.dark-mode .variables-title {
            color: #60a5fa;
        }

        .variables-toggle {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .variables-toggle:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }

        body.dark-mode .variables-toggle {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            color: #93c5fd;
        }

        .variables-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .var-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .var-badge.placeholder {
            background: rgba(255, 20, 147, 0.1);
            color: #be185d;
            border: 1px solid rgba(255, 20, 147, 0.3);
        }

        .var-badge.entity {
            background: rgba(16, 185, 129, 0.1);
            color: #047857;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .var-badge.amount {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .var-badge.date {
            background: rgba(139, 92, 246, 0.1);
            color: #6b21a8;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        body.dark-mode .var-badge.placeholder {
            background: rgba(255, 20, 147, 0.2);
            color: #f9a8d4;
            border-color: rgba(255, 20, 147, 0.4);
        }

        body.dark-mode .var-badge.entity {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border-color: rgba(16, 185, 129, 0.4);
        }

        body.dark-mode .var-badge.amount {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border-color: rgba(245, 158, 11, 0.4);
        }

        body.dark-mode .var-badge.date {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border-color: rgba(139, 92, 246, 0.4);
        }

        .variables-detail {
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            padding-top: 12px;
            margin-top: 12px;
        }

        body.dark-mode .variables-detail {
            border-top-color: rgba(59, 130, 246, 0.3);
        }

        .var-category {
            margin-bottom: 12px;
        }

        .var-category h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        body.dark-mode .var-category h4 {
            color: #d1d5db;
        }

        .var-item {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px 4px 2px 0;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .var-item.placeholder {
            background: rgba(255, 20, 147, 0.15);
            color: #be185d;
            border: 1px solid rgba(255, 20, 147, 0.3);
        }

        .var-item.entity {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .var-item.amount {
            background: rgba(245, 158, 11, 0.15);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .var-item.date {
            background: rgba(139, 92, 246, 0.15);
            color: #6b21a8;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        body.dark-mode .var-item.placeholder {
            background: rgba(255, 20, 147, 0.25);
            color: #f9a8d4;
            border-color: rgba(255, 20, 147, 0.4);
        }

        body.dark-mode .var-item.entity {
            background: rgba(16, 185, 129, 0.25);
            color: #6ee7b7;
            border-color: rgba(16, 185, 129, 0.4);
        }

        body.dark-mode .var-item.amount {
            background: rgba(245, 158, 11, 0.25);
            color: #fbbf24;
            border-color: rgba(245, 158, 11, 0.4);
        }

        body.dark-mode .var-item.date {
            background: rgba(139, 92, 246, 0.25);
            color: #c4b5fd;
            border-color: rgba(139, 92, 246, 0.4);
        }

        /* Responsive variables display */
        @media (max-width: 768px) {
            .variables-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .variables-summary {
                justify-content: center;
            }
            
            .var-badge {
                font-size: 0.75rem;
                padding: 3px 8px;
            }
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #ff1493;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 0 3px rgba(255, 20, 147, 0.2);
        }

        body.dark-mode .form-input:focus,
        body.dark-mode .form-textarea:focus,
        body.dark-mode .form-select:focus {
            background: rgba(55, 65, 81, 0.98);
        }

        .btn {
            background: #ff1493;
            color: #ffffff;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #ff69b4;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.01);
        }

        .btn.secondary {
            background: transparent;
            color: #76c59d;
            border: 2px solid #76c59d;
        }

        .btn.secondary:hover {
            background: rgba(118, 197, 157, 0.1);
            border-color: #90d698;
            color: #90d698;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: linear-gradient(45deg, #10b981, #059669);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }

        .result-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .error-card {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(118, 197, 157, 0.3);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(118, 197, 157, 0.1);
        }

        body.dark-mode .metric {
            background: rgba(45, 55, 72, 0.9);
            border-color: rgba(255, 105, 180, 0.3);
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #ff1493;
        }

        .metric-label {
            color: #2d3748;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        body.dark-mode .metric-label {
            color: #cbd5e0;
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 20, 147, 0.2);
            border-top: 3px solid #ff1493;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Cache History Styles */
        .cache-history-container {
            position: relative;
            display: inline-block;
        }

        .cache-recovery-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 20, 147, 0.9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .cache-recovery-btn:hover {
            opacity: 1;
            background: rgba(255, 20, 147, 1);
            transform: scale(1.05);
        }

        .cache-recovery-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .cache-history-dropdown {
            position: absolute;
            top: 40px;
            right: 8px;
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid rgba(255, 20, 147, 0.3);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            z-index: 1000;
            min-width: 300px;
            max-width: 500px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        body.dark-mode .cache-history-dropdown {
            background: rgba(45, 55, 72, 0.98);
            border-color: rgba(255, 105, 180, 0.4);
        }

        .cache-history-header {
            padding: 15px;
            border-bottom: 1px solid rgba(118, 197, 157, 0.2);
            font-weight: 600;
            color: #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .cache-history-header {
            color: #e2e8f0;
            border-bottom-color: rgba(255, 105, 180, 0.3);
        }

        .cache-history-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(118, 197, 157, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        body.dark-mode .cache-history-item {
            border-bottom-color: rgba(255, 105, 180, 0.2);
        }

        .cache-history-item:hover {
            background: rgba(255, 20, 147, 0.1);
        }

        body.dark-mode .cache-history-item:hover {
            background: rgba(255, 105, 180, 0.2);
        }

        .cache-history-item:last-child {
            border-bottom: none;
        }

        .cache-item-preview {
            font-size: 0.9rem;
            color: #2d3748;
            line-height: 1.4;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        body.dark-mode .cache-item-preview {
            color: #cbd5e0;
        }

        .cache-item-meta {
            font-size: 0.75rem;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cache-item-actions {
            display: flex;
            gap: 8px;
        }

        .cache-action-btn {
            background: none;
            border: none;
            color: #ff1493;
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .cache-action-btn:hover {
            background: rgba(255, 20, 147, 0.1);
        }

        .cache-clear-all {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .cache-clear-all:hover {
            background: #dc2626;
        }

        .cache-empty-state {
            padding: 30px 15px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .cache-indicator {
            position: absolute;
            top: 8px;
            right: 45px;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .cache-indicator.active {
            opacity: 1;
        }

        /* Batch Processing Styles */
        .batch-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(118, 197, 157, 0.2);
            position: relative;
        }

        body.dark-mode .batch-input-row {
            background: rgba(45, 55, 72, 0.5);
            border-color: rgba(255, 105, 180, 0.2);
        }

        .batch-input-row .form-textarea {
            min-height: 80px;
        }

        .batch-input-row .form-input, 
        .batch-input-row .form-select {
            padding: 12px 16px;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        body.dark-mode .progress-bar {
            background: rgba(45, 55, 72, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #10b981, #059669);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .batch-status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            border: 2px solid;
        }

        .batch-status.processing {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .batch-status.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .batch-status.failed {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .batch-jobs-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .batch-job-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border: 1px solid rgba(118, 197, 157, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .batch-job-item {
            background: rgba(45, 55, 72, 0.7);
            border-color: rgba(255, 105, 180, 0.2);
        }

        .batch-job-info {
            flex: 1;
        }

        .batch-job-actions {
            display: flex;
            gap: 10px;
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            margin-top: 60px;
            border-top: 1px solid rgba(118, 197, 157, 0.2);
            color: #2d3748;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.5);
        }

        body.dark-mode .footer {
            color: #cbd5e0;
            background: rgba(45, 55, 72, 0.5);
            border-top-color: rgba(255, 105, 180, 0.3);
        }

        .footer .awards {
            margin-bottom: 20px;
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .footer .awards strong {
            color: #ff1493;
        }

        .footer .philosophy {
            font-style: italic;
            color: #76c59d;
            margin-top: 15px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .menu-grid {
                grid-template-columns: 1fr;
            }

            .batch-input-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .quick-actions {
                flex-direction: column;
                align-items: center;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dark-mode-toggle" onclick="toggleDarkMode()">
        <span id="theme-icon">🌙</span>
        <span id="theme-text">Dark</span>
    </div>

    <div class="container">
        <!-- Landing Page -->
        <div id="landing" class="page active">
            <div class="header">
                <div class="logo">Thinkerbell</div>
                <div class="tagline">Enhanced Legal Text Generator</div>
                <div class="subtitle">
                    Where scientific enquiry meets hardcore creativity to transform your rough ideas into professional legal templates.<br>
                    <strong>Measured Magic</strong> for legal document creation with batch processing capabilities.
                </div>
                <div class="credentials">
                    Enhanced AI model with <strong>96.4% accuracy</strong> and <strong>84.5% Recall@5</strong>
                </div>
                
                <!-- Enhanced Menu System -->
                <div class="main-menu">
                    <div class="feature-status">
                        <div class="status-item">
                            <div class="status-dot" id="backendStatusDot"></div>
                            <span id="backendStatusText">Checking backend...</span>
                        </div>
                        <div class="status-item">
                            <div class="status-dot"></div>
                            <span>96.4% Model Accuracy</span>
                        </div>
                        <div class="status-item">
                            <div class="status-dot"></div>
                            <span>84.5% Recall@5</span>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="loadSampleData(); showPage('generator');">
                            ⚡ Quick Start
                        </button>
                        <button class="quick-action-btn" onclick="loadBatchSampleData(); showPage('batch');">
                            🚀 Batch Demo
                        </button>
                        <button class="quick-action-btn" onclick="showPage('tester');">
                            🔬 Test Similarity
                        </button>
                    </div>

                    <div class="menu-grid">
                        <!-- Single Generation Card -->
                        <div class="menu-card single" onclick="showPage('generator')">
                            <div class="menu-icon">⚖️</div>
                            <div class="menu-title">Single Generation</div>
                            <div class="menu-description">
                                Transform one legal text example into a professional template with intelligent auto-detection
                            </div>
                            <ul class="menu-features">
                                <li>🤖 Auto-detects document type & style</li>
                                <li>📏 Smart length optimization</li>
                                <li>⚡ Real-time parameter detection</li>
                                <li>📄 Download as .txt files</li>
                            </ul>
                            <div class="menu-badge popular">Most Popular</div>
                        </div>

                        <!-- Batch Processing Card -->
                        <div class="menu-card batch" onclick="showPage('batch')">
                            <div class="menu-icon">📦</div>
                            <div class="menu-title">Batch Processing</div>
                            <div class="menu-description">
                                Process multiple legal documents simultaneously with intelligent auto-detection
                            </div>
                            <ul class="menu-features">
                                <li>🤖 Auto-detects each document's parameters</li>
                                <li>📊 Real-time progress tracking</li>
                                <li>📦 Download as organized ZIP files</li>
                                <li>📋 Complete job history management</li>
                            </ul>
                            <div class="menu-badge new">New Feature</div>
                        </div>

                        <!-- Model Testing Card -->
                        <div class="menu-card test" onclick="showPage('tester')">
                            <div class="menu-icon">🧪</div>
                            <div class="menu-title">Model Testing</div>
                            <div class="menu-description">
                                Test similarity analysis and explore model capabilities
                            </div>
                            <ul class="menu-features">
                                <li>Text similarity comparison</li>
                                <li>Model performance metrics</li>
                                <li>Real-time analysis</li>
                                <li>Interactive testing</li>
                            </ul>
                            <div class="menu-badge advanced">Advanced</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🎯 What This Tool Does</h3>
                <p style="margin-top: 15px; line-height: 1.6;">
                    Transform your rough, human-written legal text examples into professional, comprehensive legal templates. 
                    Now with powerful batch processing capabilities to handle multiple documents at once!
                </p>
            </div>

            <div class="grid">
                <div class="metric">
                    <div class="metric-value">600-800</div>
                    <div class="metric-label">Recommended Input Length (words)</div>
                </div>
                <div class="metric">
                    <div class="metric-value">96.4%</div>
                    <div class="metric-label">Model Accuracy</div>
                </div>
                <div class="metric">
                    <div class="metric-value">84.5%</div>
                    <div class="metric-label">Recall@5 Performance</div>
                </div>
                <div class="metric">
                    <div class="metric-value">∞</div>
                    <div class="metric-label">Batch Processing Capacity</div>
                </div>
            </div>
        </div>

        <!-- Single Generation Page -->
        <div id="generator" class="page">
            <button class="back-btn" onclick="showPage('landing')">← Back to Home</button>
            
            <div class="header">
                <h1>⚖️ Legal Text Generator</h1>
                <p class="subtitle">Transform your rough examples into professional legal templates</p>
            </div>

            <div class="card">
                <div class="form-group human-example-container">
                    <label class="human-example-label">Your Human Example (600-800 words recommended)</label>
                    <div class="cache-history-container">
                        <textarea id="humanExample" class="form-textarea" 
                            placeholder="Describe your legal agreement in plain language. Include key terms like duration, compensation, deliverables, restrictions, and any specific requirements. The more detail you provide, the better the generated template will be.

Example: 'I need a contract for working with an Instagram influencer. They will post about our skincare products twice a week for 2 months. We'll pay them $2000 plus send free products. They need to use our hashtags and mention our brand...'"></textarea>
                        <div class="cache-indicator" id="humanExampleCacheIndicator"></div>
                        <button class="cache-recovery-btn" id="humanExampleRecoveryBtn" onclick="toggleCacheHistory('humanExample')" disabled>
                            📝 History
                        </button>
                        <div class="cache-history-dropdown" id="humanExampleCacheDropdown">
                            <div class="cache-history-header">
                                <span>📝 Text History</span>
                                <button class="cache-clear-all" onclick="clearCacheHistory('humanExample')">Clear All</button>
                            </div>
                            <div id="humanExampleCacheList" class="cache-history-list">
                                <div class="cache-empty-state">No saved text history yet</div>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-stats">
                        <div class="stat-item">
                            <span id="charCount">0</span> characters
                        </div>
                        <div class="stat-item">
                            <span id="wordCount">0</span> words
                        </div>
                        <div class="stat-item" style="color: #10b981; font-weight: 600;">
                            <span id="readabilityScore">Ready to type</span>
                        </div>
                    </div>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label class="form-label">Target Length:</label>
                        <select id="targetLength" class="form-select">
                            <option value="500">Short (500 words)</option>
                            <option value="700" selected>Medium (700 words)</option>
                            <option value="1000">Long (1000 words)</option>
                            <option value="1200">Comprehensive (1200 words)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Style Preference:</label>
                        <select id="stylePreference" class="form-select">
                            <option value="professional" selected>Professional</option>
                            <option value="formal">Formal Legal</option>
                            <option value="business">Business Casual</option>
                            <option value="detailed">Highly Detailed</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Document Type:</label>
                    <select id="documentType" class="form-select">
                        <option value="legal_template" selected>Legal Template</option>
                        <option value="influencer_agreement">Influencer Agreement</option>
                        <option value="brand_partnership">Brand Partnership</option>
                        <option value="content_creation">Content Creation Contract</option>
                        <option value="marketing_agreement">Marketing Agreement</option>
                    </select>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn success" onclick="loadSampleData()">Load Sample Data</button>
                    <button class="btn secondary" onclick="manualAutoDetect()">🤖 Auto-Detect Parameters</button>
                    <button class="btn" onclick="generateText()" id="generateBtn">🚀 Generate Legal Template</button>
                </div>

                <div id="backendStatus" style="margin: 20px 0; text-align: center;">
                    <span class="status-indicator status-offline"></span>
                    <span>Checking backend connection...</span>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <div class="card">
                    <h3>📄 Generated Legal Template</h3>
                    
                    <div class="grid" id="metricsGrid">
                        <!-- Metrics will be populated here -->
                    </div>

                    <div class="result-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>Generated Text:</h4>
                            <div>
                                <button class="btn success" onclick="copyToClipboard()">Copy Text</button>
                                <button class="btn secondary" onclick="downloadSingleResult()">📄 Download .txt</button>
                            </div>
                        </div>
                        <pre id="generatedText" style="white-space: pre-wrap; line-height: 1.6;"></pre>
                    </div>
                </div>
            </div>

            <div id="errorSection" style="display: none;">
                <div class="error-card">
                    <h4>❌ Error</h4>
                    <p id="errorMessage"></p>
                </div>
            </div>
        </div>

        <!-- Batch Processing Page -->
        <div id="batch" class="page">
            <button class="back-btn" onclick="showPage('landing')">← Back to Home</button>
            
            <div class="header">
                <h1>📦 Batch Processing</h1>
                <p class="subtitle">Process multiple legal text examples at once with advanced workflow management</p>
                
                <!-- Batch Processing Navigation -->
                <div class="quick-actions" style="margin-top: 20px;">
                    <button class="quick-action-btn" onclick="scrollToSection('batch-input')">
                        📝 Configure Batch
                    </button>
                    <button class="quick-action-btn" onclick="scrollToSection('batch-status')">
                        📊 View Status
                    </button>
                    <button class="quick-action-btn" onclick="scrollToSection('batch-history')">
                        📋 Job History
                    </button>
                    <button class="quick-action-btn" onclick="loadBatchSampleData()">
                        ⚡ Load Samples
                    </button>
                </div>
            </div>

            <!-- Batch Input Section -->
            <div class="card" id="batch-input">
                <h3>📝 Batch Input Configuration</h3>
                <div class="feature-status" style="margin-bottom: 20px;">
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span id="batchInputCount">1 input configured</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot" id="batchValidationStatus"></div>
                        <span id="batchValidationText">Ready to configure</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Batch Name:</label>
                    <input type="text" id="batchName" class="form-input" placeholder="Enter a name for this batch..." value="Legal Documents Batch">
                </div>

                <!-- Manual Batch Input -->
                <div id="batchInputs">
                    <div class="batch-input-row">
                        <div class="form-group">
                            <label class="form-label">Human Example:</label>
                            <div class="cache-history-container">
                                <textarea class="form-textarea batch-human-example" placeholder="Enter legal text example..."></textarea>
                                <div class="cache-indicator batch-cache-indicator"></div>
                                <button class="cache-recovery-btn batch-recovery-btn" onclick="toggleBatchCacheHistory(this)" disabled>
                                    📝 History
                                </button>
                                <div class="cache-history-dropdown batch-cache-dropdown">
                                    <div class="cache-history-header">
                                        <span>📝 Text History</span>
                                        <button class="cache-clear-all" onclick="clearBatchCacheHistory(this)">Clear All</button>
                                    </div>
                                    <div class="cache-history-list batch-cache-list">
                                        <div class="cache-empty-state">No saved text history yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Length:</label>
                            <select class="form-select batch-target-length">
                                <option value="500">Short (500)</option>
                                <option value="700" selected>Medium (700)</option>
                                <option value="1000">Long (1000)</option>
                                <option value="1200">Comprehensive (1200)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Style:</label>
                            <select class="form-select batch-style">
                                <option value="professional" selected>Professional</option>
                                <option value="formal">Formal</option>
                                <option value="business">Business</option>
                                <option value="detailed">Detailed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Document Type:</label>
                            <select class="form-select batch-document-type">
                                <option value="legal_template" selected>Legal Template</option>
                                <option value="influencer_agreement">Influencer Agreement</option>
                                <option value="brand_partnership">Brand Partnership</option>
                                <option value="content_creation">Content Creation</option>
                                <option value="marketing_agreement">Marketing Agreement</option>
                            </select>
                        </div>
                        <button class="remove-btn" onclick="removeBatchInput(this)" style="display: none;">Remove</button>
                    </div>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn secondary" onclick="addBatchInput()">➕ Add Another Input</button>
                    <button class="btn success" onclick="loadBatchSampleData()">Load Sample Batch</button>
                    <button class="btn" onclick="startBatchProcessing()" id="batchProcessBtn">🚀 Start Batch Processing</button>
                </div>
            </div>

            <!-- Batch Status Section -->
            <div id="batchStatusSection" style="display: none;">
                <div class="card" id="batch-status">
                    <h3>📊 Batch Processing Status</h3>
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <button class="quick-action-btn" onclick="refreshBatchStatus()" id="refreshStatusBtn">
                            🔄 Refresh
                        </button>
                    </div>
                    <div id="batchStatusContent">
                        <!-- Status content will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Batch Jobs Management -->
            <div class="card" id="batch-history">
                <h3>📋 Batch Jobs History</h3>
                <div class="feature-status" style="margin-bottom: 20px;">
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span id="totalJobsCount">0 total jobs</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span id="completedJobsCount">0 completed</span>
                    </div>
                    <div class="status-item">
                        <div class="status-dot warning"></div>
                        <span id="processingJobsCount">0 processing</span>
                    </div>
                </div>
                <div class="quick-actions" style="margin-bottom: 20px;">
                    <button class="quick-action-btn" onclick="refreshBatchJobs()">
                        🔄 Refresh Jobs
                    </button>
                    <button class="quick-action-btn" onclick="exportJobsHistory()">
                        📤 Export History
                    </button>
                </div>
                <div id="batchJobsList" class="batch-jobs-list">
                    <!-- Batch jobs will be populated here -->
                </div>
            </div>
        </div>

        <!-- Model Tester Page -->
        <div id="tester" class="page">
            <button class="back-btn" onclick="showPage('landing')">← Back to Home</button>
            
            <div class="header">
                <h1>🧪 Model Tester</h1>
                <p class="subtitle">Test similarity, search, and analysis capabilities</p>
            </div>

            <div class="card">
                <h3>🔍 Text Similarity Test</h3>
                <div class="form-group">
                    <label class="form-label">Text 1:</label>
                    <div class="cache-history-container">
                        <textarea id="text1" class="form-textarea" rows="3" 
                            placeholder="Enter first text..."></textarea>
                        <div class="cache-indicator" id="text1CacheIndicator"></div>
                        <button class="cache-recovery-btn" id="text1RecoveryBtn" onclick="toggleCacheHistory('text1')" disabled>
                            📝 History
                        </button>
                        <div class="cache-history-dropdown" id="text1CacheDropdown">
                            <div class="cache-history-header">
                                <span>📝 Text History</span>
                                <button class="cache-clear-all" onclick="clearCacheHistory('text1')">Clear All</button>
                            </div>
                            <div id="text1CacheList" class="cache-history-list">
                                <div class="cache-empty-state">No saved text history yet</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Text 2:</label>
                    <div class="cache-history-container">
                        <textarea id="text2" class="form-textarea" rows="3" 
                            placeholder="Enter second text..."></textarea>
                        <div class="cache-indicator" id="text2CacheIndicator"></div>
                        <button class="cache-recovery-btn" id="text2RecoveryBtn" onclick="toggleCacheHistory('text2')" disabled>
                            📝 History
                        </button>
                        <div class="cache-history-dropdown" id="text2CacheDropdown">
                            <div class="cache-history-header">
                                <span>📝 Text History</span>
                                <button class="cache-clear-all" onclick="clearCacheHistory('text2')">Clear All</button>
                            </div>
                            <div id="text2CacheList" class="cache-history-list">
                                <div class="cache-empty-state">No saved text history yet</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="testSimilarity()">Compare Similarity</button>
                <div id="similarityResult"></div>
            </div>
        </div>
    </div>

    <script>
        let currentResult = null;
        let currentBatchId = null;
        let batchStatusInterval = null;

        // Cache History Management
        class CacheHistoryManager {
            constructor() {
                this.maxEntries = 10; // Maximum number of cached entries per field
                this.minLength = 10; // Minimum text length to cache
                this.debounceTime = 2000; // Time to wait before saving (ms)
                this.debounceTimers = new Map();
                this.activeDropdowns = new Set();
                
                // Initialize cache for tracked fields
                this.initializeCacheForField('humanExample');
                this.initializeCacheForField('text1');
                this.initializeCacheForField('text2');
                
                // Add click outside listener to close dropdowns
                document.addEventListener('click', (e) => this.handleClickOutside(e));
            }
            
            initializeCacheForField(fieldId) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', (e) => this.handleTextInput(fieldId, e.target.value));
                    field.addEventListener('paste', (e) => {
                        setTimeout(() => this.handleTextInput(fieldId, e.target.value), 100);
                    });
                    
                    // Load existing cache and update UI
                    this.updateCacheUI(fieldId);
                }
            }
            
            handleTextInput(fieldId, text) {
                // Clear existing timer
                if (this.debounceTimers.has(fieldId)) {
                    clearTimeout(this.debounceTimers.get(fieldId));
                }
                
                // Show cache indicator briefly
                this.showCacheIndicator(fieldId);
                
                // Set new timer to save after debounce period
                if (text.length >= this.minLength) {
                    const timer = setTimeout(() => {
                        this.saveToCache(fieldId, text);
                    }, this.debounceTime);
                    
                    this.debounceTimers.set(fieldId, timer);
                }
            }
            
            showCacheIndicator(fieldId) {
                const indicator = document.getElementById(`${fieldId}CacheIndicator`);
                if (indicator) {
                    indicator.classList.add('active');
                    setTimeout(() => {
                        indicator.classList.remove('active');
                    }, 1500);
                }
            }
            
            saveToCache(fieldId, text) {
                if (!text || text.length < this.minLength) return;
                
                const cacheKey = `cache_${fieldId}`;
                let cache = JSON.parse(localStorage.getItem(cacheKey) || '[]');
                
                // Don't save if it's the same as the most recent entry
                if (cache.length > 0 && cache[0].text === text) return;
                
                // Create new cache entry
                const entry = {
                    text: text,
                    timestamp: Date.now(),
                    preview: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
                    wordCount: text.split(/\s+/).filter(word => word.length > 0).length
                };
                
                // Add to beginning of array
                cache.unshift(entry);
                
                // Limit cache size
                if (cache.length > this.maxEntries) {
                    cache = cache.slice(0, this.maxEntries);
                }
                
                // Save to localStorage
                localStorage.setItem(cacheKey, JSON.stringify(cache));
                
                // Update UI
                this.updateCacheUI(fieldId);
                
                // Show brief success indicator
                this.showCacheIndicator(fieldId);
            }
            
            updateCacheUI(fieldId) {
                const cache = this.getCache(fieldId);
                const recoveryBtn = document.getElementById(`${fieldId}RecoveryBtn`);
                const cacheList = document.getElementById(`${fieldId}CacheList`);
                
                if (recoveryBtn) {
                    recoveryBtn.disabled = cache.length === 0;
                }
                
                if (cacheList) {
                    if (cache.length === 0) {
                        cacheList.innerHTML = '<div class="cache-empty-state">No saved text history yet</div>';
                    } else {
                        cacheList.innerHTML = cache.map((entry, index) => `
                            <div class="cache-history-item" onclick="cacheHistoryManager.restoreFromCache('${fieldId}', ${index})">
                                <div class="cache-item-preview">${entry.preview}</div>
                                <div class="cache-item-meta">
                                    <span>${entry.wordCount} words • ${this.formatTimestamp(entry.timestamp)}</span>
                                    <div class="cache-item-actions">
                                        <button class="cache-action-btn" onclick="event.stopPropagation(); cacheHistoryManager.deleteFromCache('${fieldId}', ${index})">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }
            
            getCache(fieldId) {
                const cacheKey = `cache_${fieldId}`;
                return JSON.parse(localStorage.getItem(cacheKey) || '[]');
            }
            
            restoreFromCache(fieldId, index) {
                const cache = this.getCache(fieldId);
                if (cache[index]) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = cache[index].text;
                        
                        // Trigger input event to update counters and other functionality
                        field.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        // Close dropdown
                        this.closeCacheDropdown(fieldId);
                        
                        // Show success message
                        showTemporaryMessage('✅ Text restored from history!', 'success');
                    }
                }
            }
            
            deleteFromCache(fieldId, index) {
                const cacheKey = `cache_${fieldId}`;
                let cache = this.getCache(fieldId);
                
                if (cache[index]) {
                    cache.splice(index, 1);
                    localStorage.setItem(cacheKey, JSON.stringify(cache));
                    this.updateCacheUI(fieldId);
                    showTemporaryMessage('🗑️ Cache entry deleted', 'info');
                }
            }
            
            clearCache(fieldId) {
                const cacheKey = `cache_${fieldId}`;
                localStorage.removeItem(cacheKey);
                this.updateCacheUI(fieldId);
                this.closeCacheDropdown(fieldId);
                showTemporaryMessage('🗑️ All cache history cleared', 'info');
            }
            
            toggleCacheDropdown(fieldId) {
                const dropdown = document.getElementById(`${fieldId}CacheDropdown`);
                if (dropdown) {
                    const isVisible = dropdown.style.display === 'block';
                    
                    // Close all other dropdowns first
                    this.closeAllDropdowns();
                    
                    if (!isVisible) {
                        dropdown.style.display = 'block';
                        this.activeDropdowns.add(fieldId);
                        // Refresh cache UI when opening
                        this.updateCacheUI(fieldId);
                    }
                }
            }
            
            closeCacheDropdown(fieldId) {
                const dropdown = document.getElementById(`${fieldId}CacheDropdown`);
                if (dropdown) {
                    dropdown.style.display = 'none';
                    this.activeDropdowns.delete(fieldId);
                }
            }
            
            closeAllDropdowns() {
                this.activeDropdowns.forEach(fieldId => {
                    this.closeCacheDropdown(fieldId);
                });
            }
            
            handleClickOutside(event) {
                // Check if click is outside any cache dropdown
                if (!event.target.closest('.cache-history-container')) {
                    this.closeAllDropdowns();
                }
            }
            
            formatTimestamp(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                if (diff < 60000) { // Less than 1 minute
                    return 'Just now';
                } else if (diff < 3600000) { // Less than 1 hour
                    return `${Math.floor(diff / 60000)}m ago`;
                } else if (diff < 86400000) { // Less than 1 day
                    return `${Math.floor(diff / 3600000)}h ago`;
                } else {
                    return new Date(timestamp).toLocaleDateString();
                }
            }
        }

        // Initialize cache history manager
        let cacheHistoryManager;

        // Global cache history functions (called from HTML)
        function toggleCacheHistory(fieldId) {
            if (cacheHistoryManager) {
                cacheHistoryManager.toggleCacheDropdown(fieldId);
            }
        }

        function clearCacheHistory(fieldId) {
            if (cacheHistoryManager) {
                cacheHistoryManager.clearCache(fieldId);
            }
        }

        // Batch cache history functions
        function toggleBatchCacheHistory(button) {
            const row = button.closest('.batch-input-row');
            const textarea = row.querySelector('.batch-human-example');
            const dropdown = row.querySelector('.batch-cache-dropdown');
            const cacheList = row.querySelector('.batch-cache-list');
            
            if (dropdown) {
                const isVisible = dropdown.style.display === 'block';
                
                // Close all other batch dropdowns
                document.querySelectorAll('.batch-cache-dropdown').forEach(d => {
                    if (d !== dropdown) d.style.display = 'none';
                });
                
                if (!isVisible) {
                    dropdown.style.display = 'block';
                    updateBatchCacheUI(row, textarea, cacheList);
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }

        function clearBatchCacheHistory(button) {
            const row = button.closest('.batch-input-row');
            const textarea = row.querySelector('.batch-human-example');
            const cacheKey = `batch_cache_${textarea.dataset.cacheId || 'default'}`;
            
            localStorage.removeItem(cacheKey);
            updateBatchCacheUI(row, textarea, row.querySelector('.batch-cache-list'));
            row.querySelector('.batch-cache-dropdown').style.display = 'none';
            showTemporaryMessage('🗑️ Batch cache history cleared', 'info');
        }

        function updateBatchCacheUI(row, textarea, cacheList) {
            const cacheKey = `batch_cache_${textarea.dataset.cacheId || 'default'}`;
            const cache = JSON.parse(localStorage.getItem(cacheKey) || '[]');
            const recoveryBtn = row.querySelector('.batch-recovery-btn');
            
            if (recoveryBtn) {
                recoveryBtn.disabled = cache.length === 0;
            }
            
            if (cacheList) {
                if (cache.length === 0) {
                    cacheList.innerHTML = '<div class="cache-empty-state">No saved text history yet</div>';
                } else {
                    cacheList.innerHTML = cache.map((entry, index) => `
                        <div class="cache-history-item" onclick="restoreBatchFromCache(this, ${index})">
                            <div class="cache-item-preview">${entry.preview}</div>
                            <div class="cache-item-meta">
                                <span>${entry.wordCount} words • ${formatBatchTimestamp(entry.timestamp)}</span>
                                <div class="cache-item-actions">
                                    <button class="cache-action-btn" onclick="event.stopPropagation(); deleteBatchFromCache(this, ${index})">Delete</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        function restoreBatchFromCache(item, index) {
            const row = item.closest('.batch-input-row');
            const textarea = row.querySelector('.batch-human-example');
            const cacheKey = `batch_cache_${textarea.dataset.cacheId || 'default'}`;
            const cache = JSON.parse(localStorage.getItem(cacheKey) || '[]');
            
            if (cache[index]) {
                textarea.value = cache[index].text;
                textarea.dispatchEvent(new Event('input', { bubbles: true }));
                row.querySelector('.batch-cache-dropdown').style.display = 'none';
                showTemporaryMessage('✅ Batch text restored from history!', 'success');
            }
        }

        function deleteBatchFromCache(button, index) {
            const row = button.closest('.batch-input-row');
            const textarea = row.querySelector('.batch-human-example');
            const cacheKey = `batch_cache_${textarea.dataset.cacheId || 'default'}`;
            let cache = JSON.parse(localStorage.getItem(cacheKey) || '[]');
            
            if (cache[index]) {
                cache.splice(index, 1);
                localStorage.setItem(cacheKey, JSON.stringify(cache));
                updateBatchCacheUI(row, textarea, row.querySelector('.batch-cache-list'));
                showTemporaryMessage('🗑️ Batch cache entry deleted', 'info');
            }
        }

        function formatBatchTimestamp(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return 'Just now';
            else if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            else if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            else return new Date(timestamp).toLocaleDateString();
        }

        // Batch cache input handler
        let batchCacheTimers = new Map();
        
        function handleBatchCacheInput(row, text) {
            const textarea = row.querySelector('.batch-human-example');
            const cacheId = textarea.dataset.cacheId || 'default';
            
            // Clear existing timer
            if (batchCacheTimers.has(cacheId)) {
                clearTimeout(batchCacheTimers.get(cacheId));
            }
            
            // Show cache indicator briefly
            const indicator = row.querySelector('.batch-cache-indicator');
            if (indicator) {
                indicator.classList.add('active');
                setTimeout(() => {
                    indicator.classList.remove('active');
                }, 1500);
            }
            
            // Set new timer to save after debounce period
            if (text && text.length >= 10) {
                const timer = setTimeout(() => {
                    saveBatchToCache(cacheId, text);
                    updateBatchCacheUI(row, textarea, row.querySelector('.batch-cache-list'));
                }, 2000);
                
                batchCacheTimers.set(cacheId, timer);
            }
        }
        
        function saveBatchToCache(cacheId, text) {
            if (!text || text.length < 10) return;
            
            const cacheKey = `batch_cache_${cacheId}`;
            let cache = JSON.parse(localStorage.getItem(cacheKey) || '[]');
            
            // Don't save if it's the same as the most recent entry
            if (cache.length > 0 && cache[0].text === text) return;
            
            // Create new cache entry
            const entry = {
                text: text,
                timestamp: Date.now(),
                preview: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
                wordCount: text.split(/\s+/).filter(word => word.length > 0).length
            };
            
            // Add to beginning of array
            cache.unshift(entry);
            
            // Limit cache size
            if (cache.length > 10) {
                cache = cache.slice(0, 10);
            }
            
            // Save to localStorage
            localStorage.setItem(cacheKey, JSON.stringify(cache));
        }

        // Navigation
        function showPage(pageId) {
            console.log(`Navigating to ${pageId}`);
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Load batch jobs when showing batch page
            if (pageId === 'batch') {
                refreshBatchJobs();
            }
        }

        // Update character and word count and auto-detect parameters
        document.getElementById('humanExample')?.addEventListener('input', function() {
            const text = this.value;
            const charCount = text.length;
            const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
            
            document.getElementById('charCount').textContent = charCount;
            document.getElementById('wordCount').textContent = wordCount;
            
            // Update readability score
            updateReadabilityScore(wordCount, charCount);
            
            // Detect and display key variables
            if (text.length > 20) {
                const variables = detectKeyVariables(text);
                displayDetectedVariables(variables);
            } else {
                // Hide variables display if text is too short
                const variablesDisplay = document.getElementById('detectedVariables');
                if (variablesDisplay) {
                    variablesDisplay.style.display = 'none';
                }
            }
            
            // Auto-detect parameters if text is long enough
            if (text.length > 50) {
                debounceAutoDetect(text);
            }
        });

        // Update readability score based on text metrics
        function updateReadabilityScore(wordCount, charCount) {
            const readabilityEl = document.getElementById('readabilityScore');
            if (!readabilityEl) return;
            
            let score = 'Ready to type';
            let color = '#10b981';
            
            if (wordCount === 0) {
                score = 'Ready to type';
                color = '#10b981';
            } else if (wordCount < 50) {
                score = 'Too short - add more detail';
                color = '#f59e0b';
            } else if (wordCount < 200) {
                score = 'Getting better - add more';
                color = '#3b82f6';
            } else if (wordCount >= 200 && wordCount <= 800) {
                score = 'Perfect length! 🎯';
                color = '#10b981';
            } else if (wordCount > 800 && wordCount <= 1200) {
                score = 'Very detailed - excellent!';
                color = '#059669';
            } else {
                score = 'Very long - consider condensing';
                color = '#f59e0b';
            }
            
            readabilityEl.textContent = score;
            readabilityEl.style.color = color;
        }

        // Enhanced variable detection and parsing with comprehensive threading
        function detectKeyVariables(text) {
            const variables = {
                placeholders: [],
                entities: [],
                dates: [],
                amounts: [],
                locations: [],
                contacts: [],
                legal_identifiers: [],
                addresses: []
            };
            
            // Detect bracketed placeholders [VARIABLE_NAME]
            const placeholderRegex = /\[([^\]]+)\]/g;
            let match;
            while ((match = placeholderRegex.exec(text)) !== null) {
                variables.placeholders.push({
                    full: match[0],
                    name: match[1],
                    position: match.index
                });
            }
            
            // Detect company names and entities
            const entityPatterns = [
                /(\w+\s+Pty)/gi,
                /(\w+\s+Ltd)/gi,
                /(\w+\s+LLC)/gi,
                /(\w+\s+Inc)/gi,
                /(\w+\s+Corporation)/gi,
                /(\w+\s+Company)/gi
            ];
            
            entityPatterns.forEach(pattern => {
                let entityMatch;
                while ((entityMatch = pattern.exec(text)) !== null) {
                    variables.entities.push({
                        name: entityMatch[1],
                        type: 'company',
                        position: entityMatch.index
                    });
                }
            });
            
            // Detect monetary amounts
            const amountRegex = /\$[\d,]+(?:\.\d{2})?/g;
            while ((match = amountRegex.exec(text)) !== null) {
                variables.amounts.push({
                    amount: match[0],
                    position: match.index
                });
            }
            
            // Detect Australian Business Numbers (ABN) and Australian Company Numbers (ACN)
            const abnRegex = /ABN\s+(\d{2}\s+\d{3}\s+\d{3}\s+\d{3}|\d{11})/gi;
            while ((match = abnRegex.exec(text)) !== null) {
                variables.legal_identifiers.push({
                    type: 'ABN',
                    value: match[1],
                    position: match.index
                });
            }
            
            const acnRegex = /ACN\s+(\d{3}\s+\d{3}\s+\d{3}|\d{9})/gi;
            while ((match = acnRegex.exec(text)) !== null) {
                variables.legal_identifiers.push({
                    type: 'ACN',
                    value: match[1],
                    position: match.index
                });
            }
            
            // Detect Australian states and territories
            const stateRegex = /(NSW|VIC|QLD|WA|SA|TAS|ACT|NT|New South Wales|Victoria|Queensland|Western Australia|South Australia|Tasmania|Australian Capital Territory|Northern Territory)/gi;
            while ((match = stateRegex.exec(text)) !== null) {
                variables.locations.push({
                    type: 'state',
                    value: match[1],
                    position: match.index
                });
            }
            
            // Detect email addresses
            const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
            while ((match = emailRegex.exec(text)) !== null) {
                variables.contacts.push({
                    type: 'email',
                    value: match[0],
                    position: match.index
                });
            }
            
            // Detect Australian phone numbers
            const phoneRegex = /(\+61\s*[0-9\s]{9,12}|\b04\d{2}\s*\d{3}\s*\d{3}\b|\([0-9]{2}\)\s*[0-9]{4}\s*[0-9]{4}|\b0[2-8]\s*[0-9]{4}\s*[0-9]{4}\b)/g;
            while ((match = phoneRegex.exec(text)) !== null) {
                variables.contacts.push({
                    type: 'phone',
                    value: match[0],
                    position: match.index
                });
            }
            
            // Detect Australian addresses
            const addressRegex = /(Level\s+\d+,\s*\d+[-\d]*\s+[A-Za-z\s]+(?:Street|St|Road|Rd|Avenue|Ave|Lane|Ln|Drive|Dr|Place|Pl|Court|Ct|Crescent|Cres),\s*[A-Za-z\s]+,\s*(?:NSW|VIC|QLD|WA|SA|TAS|ACT|NT)\s+\d{4})/gi;
            while ((match = addressRegex.exec(text)) !== null) {
                variables.addresses.push({
                    value: match[0],
                    position: match.index
                });
            }
            
            // Detect dates and time periods
            const datePatterns = [
                /\d{1,2}\/\d{1,2}\/\d{4}/g,
                /\d{1,2}-\d{1,2}-\d{4}/g,
                /\d+\s+(?:days?|weeks?|months?|years?)/gi,
                /(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}/gi
            ];
            
            datePatterns.forEach(pattern => {
                let dateMatch;
                while ((dateMatch = pattern.exec(text)) !== null) {
                    variables.dates.push({
                        date: dateMatch[0],
                        position: dateMatch.index
                    });
                }
            });
            
            return variables;
        }

        // Display detected variables in UI
        function displayDetectedVariables(variables) {
            let variablesDisplay = document.getElementById('detectedVariables');
            if (!variablesDisplay) {
                // Create variables display if it doesn't exist
                variablesDisplay = document.createElement('div');
                variablesDisplay.id = 'detectedVariables';
                variablesDisplay.className = 'detected-variables';
                
                const statsContainer = document.querySelector('.textarea-stats');
                if (statsContainer) {
                    statsContainer.parentNode.insertBefore(variablesDisplay, statsContainer.nextSibling);
                }
            }
            
            const totalVariables = variables.placeholders.length + variables.entities.length + 
                                 variables.amounts.length + variables.dates.length;
            
            if (totalVariables === 0) {
                variablesDisplay.style.display = 'none';
                return;
            }
            
            variablesDisplay.style.display = 'block';
            variablesDisplay.innerHTML = `
                <div class="variables-header">
                    <span class="variables-title">🎯 Detected Key Variables (${totalVariables})</span>
                    <button class="variables-toggle" onclick="toggleVariablesDetail()">Show Details</button>
                </div>
                <div class="variables-summary">
                    ${variables.placeholders.length > 0 ? `<span class="var-badge placeholder">${variables.placeholders.length} Placeholders</span>` : ''}
                    ${variables.entities.length > 0 ? `<span class="var-badge entity">${variables.entities.length} Companies</span>` : ''}
                    ${variables.amounts.length > 0 ? `<span class="var-badge amount">${variables.amounts.length} Amounts</span>` : ''}
                    ${variables.dates.length > 0 ? `<span class="var-badge date">${variables.dates.length} Dates</span>` : ''}
                </div>
                <div class="variables-detail" id="variablesDetail" style="display: none;">
                    ${variables.placeholders.length > 0 ? `
                        <div class="var-category">
                            <h4>📝 Placeholders to Fill:</h4>
                            ${variables.placeholders.map(p => `<span class="var-item placeholder">${p.full}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${variables.entities.length > 0 ? `
                        <div class="var-category">
                            <h4>🏢 Company Names:</h4>
                            ${variables.entities.map(e => `<span class="var-item entity">${e.name}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${variables.amounts.length > 0 ? `
                        <div class="var-category">
                            <h4>💰 Monetary Amounts:</h4>
                            ${variables.amounts.map(a => `<span class="var-item amount">${a.amount}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${variables.dates.length > 0 ? `
                        <div class="var-category">
                            <h4>📅 Dates & Periods:</h4>
                            ${variables.dates.map(d => `<span class="var-item date">${d.date}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function toggleVariablesDetail() {
            const detail = document.getElementById('variablesDetail');
            const button = document.querySelector('.variables-toggle');
            if (detail && button) {
                if (detail.style.display === 'none') {
                    detail.style.display = 'block';
                    button.textContent = 'Hide Details';
                } else {
                    detail.style.display = 'none';
                    button.textContent = 'Show Details';
                }
            }
        }

        // Debounce auto-detection to avoid too many API calls
        let autoDetectTimeout;
        function debounceAutoDetect(text) {
            clearTimeout(autoDetectTimeout);
            autoDetectTimeout = setTimeout(() => {
                autoDetectParameters(text);
            }, 1000); // Wait 1 second after user stops typing
        }

        // Auto-detect parameters from text
        async function autoDetectParameters(text) {
            if (!text || text.length < 50) return;
            
            try {
                const backendOnline = await checkBackendStatus();
                
                if (backendOnline) {
                    const response = await fetch('/auto-detect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: text })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        updateDetectedParameters(result);
                    } else {
                        console.log('Auto-detection failed, using fallback');
                        const fallbackResult = fallbackAutoDetect(text);
                        updateDetectedParameters(fallbackResult);
                    }
                } else {
                    // Use fallback detection when backend is offline
                    const fallbackResult = fallbackAutoDetect(text);
                    updateDetectedParameters(fallbackResult);
                }
            } catch (error) {
                console.error('Auto-detection error:', error);
                // Use fallback detection on error
                const fallbackResult = fallbackAutoDetect(text);
                updateDetectedParameters(fallbackResult);
            }
        }

        // Fallback auto-detection for when backend is offline
        function fallbackAutoDetect(text) {
            const textLower = text.toLowerCase();
            const wordCount = text.split(/\s+/).length;
            
            // Simple document type detection
            let documentType = 'legal_template';
            if (textLower.includes('influencer') || textLower.includes('instagram') || textLower.includes('social media')) {
                documentType = 'influencer_agreement';
            } else if (textLower.includes('content') || textLower.includes('article') || textLower.includes('blog')) {
                documentType = 'content_creation';
            } else if (textLower.includes('brand') && textLower.includes('partnership')) {
                documentType = 'brand_partnership';
            } else if (textLower.includes('marketing') || textLower.includes('advertising')) {
                documentType = 'marketing_agreement';
            }
            
            // Simple style detection
            let stylePreference = 'professional';
            if (textLower.includes('shall') || textLower.includes('hereby') || textLower.includes('whereas')) {
                stylePreference = 'formal';
            } else if (textLower.includes('detailed') || textLower.includes('comprehensive')) {
                stylePreference = 'detailed';
            } else if (textLower.includes('business') || textLower.includes('company')) {
                stylePreference = 'business';
            }
            
            // Simple length detection
            let targetLength = 700;
            if (wordCount < 50) {
                targetLength = 500;
            } else if (wordCount > 200) {
                targetLength = 1200;
            } else if (wordCount > 100) {
                targetLength = 1000;
            }
            
            return {
                target_length: targetLength,
                style_preference: stylePreference,
                document_type: documentType,
                confidence_scores: {
                    overall: 0.6
                },
                reasoning: {
                    target_length: `Based on input length (${wordCount} words)`,
                    style_preference: `Detected from content analysis`,
                    document_type: `Inferred from keywords`
                }
            };
        }

        // Update UI with detected parameters
        function updateDetectedParameters(result) {
            // Update the select elements
            document.getElementById('targetLength').value = result.target_length;
            document.getElementById('stylePreference').value = result.style_preference;
            document.getElementById('documentType').value = result.document_type;
            
            // Show detection feedback
            showDetectionFeedback(result);
        }

        // Show auto-detection feedback to user
        function showDetectionFeedback(result) {
            const confidence = result.confidence_scores?.overall || 0.6;
            const confidencePercent = Math.round(confidence * 100);
            
            // Create or update feedback element
            let feedbackEl = document.getElementById('autoDetectFeedback');
            if (!feedbackEl) {
                feedbackEl = document.createElement('div');
                feedbackEl.id = 'autoDetectFeedback';
                feedbackEl.style.cssText = `
                    margin-top: 10px;
                    padding: 12px;
                    background: rgba(16, 185, 129, 0.1);
                    border: 1px solid rgba(16, 185, 129, 0.3);
                    border-radius: 8px;
                    font-size: 0.9rem;
                    color: #065f46;
                `;
                
                // Insert after the document type field
                const docTypeGroup = document.getElementById('documentType').closest('.form-group');
                docTypeGroup.parentNode.insertBefore(feedbackEl, docTypeGroup.nextSibling);
            }
            
            feedbackEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span>🤖</span>
                    <strong>Auto-detected parameters</strong>
                    <span style="background: rgba(16, 185, 129, 0.2); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                        ${confidencePercent}% confidence
                    </span>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.4;">
                    <div><strong>Length:</strong> ${result.target_length} words - ${result.reasoning?.target_length || 'Auto-detected'}</div>
                    <div><strong>Style:</strong> ${result.style_preference} - ${result.reasoning?.style_preference || 'Auto-detected'}</div>
                    <div><strong>Type:</strong> ${result.document_type.replace('_', ' ')} - ${result.reasoning?.document_type || 'Auto-detected'}</div>
                </div>
            `;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (feedbackEl && feedbackEl.parentNode) {
                    feedbackEl.style.opacity = '0.7';
                }
            }, 5000);
        }

        // Manual auto-detect trigger
        function manualAutoDetect() {
            const text = document.getElementById('humanExample').value.trim();
            if (!text) {
                showTemporaryMessage('Please enter some text first', 'error');
                return;
            }
            if (text.length < 50) {
                showTemporaryMessage('Please enter at least 50 characters for accurate detection', 'error');
                return;
            }
            
            showTemporaryMessage('🤖 Analyzing text...', 'info');
            autoDetectParameters(text);
        }

        // Load sample data
        function loadSampleData() {
            const sampleText = `This Influencer Marketing Agreement ('Agreement') is entered into between Between Thinkerbell Pty, a [STATE] corporation ('Company'), and [INFLUENCER NAME], an individual content creator ('Influencer'). This Agreement establishes the terms and conditions governing the professional relationship for digital marketing collaboration, content creation, and brand promotion activities across various social media platforms and digital channels.

SCOPE OF WORK AND SERVICES

The scope of this engagement encompasses content creation and publishing, video production and editing, photography and visual content development, social media story creation, product review and testimonial content, and event coverage and live content. All work shall be performed in accordance with industry best practices, brand guidelines, and applicable legal requirements.

CONTENT REQUIREMENTS AND DELIVERABLES

The Creator shall develop and publish original, high-quality content across Instagram, TikTok, YouTube, Facebook platforms. Content deliverables include feed posts, story content, video content, short-form video reels, and product reviews, all featuring Between Thinkerbell Pty's products or services in an authentic and engaging manner. All content must include proper brand attribution, mentions, and approved hashtags.

TERMS, COMPENSATION, AND PAYMENT STRUCTURE

The total compensation for this engagement is $5,000 plus product gifting valued at $500. Payment shall be made within 30 days of content delivery and approval. The engagement period spans 60 days from the effective date of this agreement.`;
            
            document.getElementById('humanExample').value = sampleText;
            document.getElementById('targetLength').value = '700';
            document.getElementById('stylePreference').value = 'professional';
            document.getElementById('documentType').value = 'legal_template';
            
            // Update counters and readability score
            const charCount = sampleText.length;
            const wordCount = sampleText.split(/\s+/).filter(word => word.length > 0).length;
            
            document.getElementById('charCount').textContent = charCount;
            document.getElementById('wordCount').textContent = wordCount;
            updateReadabilityScore(wordCount, charCount);
            
            // Trigger input event for cache and auto-detection
            document.getElementById('humanExample').dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Check backend status
        async function checkBackendStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                // Update main status indicators
                const statusDot = document.getElementById('backendStatusDot');
                const statusText = document.getElementById('backendStatusText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot';
                    statusText.textContent = `Backend Online - Model: ${data.model_loaded ? 'Loaded' : 'Not Loaded'}`;
                }
                
                // Update old status element if it exists
                const statusEl = document.getElementById('backendStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <span class="status-indicator status-online"></span>
                        <span>Backend connected - Model loaded: ${data.model_loaded}</span>
                    `;
                }
                return true;
            } catch (error) {
                // Update main status indicators
                const statusDot = document.getElementById('backendStatusDot');
                const statusText = document.getElementById('backendStatusText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot error';
                    statusText.textContent = 'Backend Offline - Demo Mode';
                }
                
                // Update old status element if it exists
                const statusEl = document.getElementById('backendStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <span class="status-indicator status-offline"></span>
                        <span>Backend offline - Using mock data for demo</span>
                    `;
                }
                return false;
            }
        }

        // Generate text (single)
        async function generateText() {
            const humanExample = document.getElementById('humanExample').value.trim();
            
            if (!humanExample) {
                showError('Please enter a human example');
                return;
            }

            if (humanExample.length < 50) {
                showError('Please provide a more detailed example (at least 50 characters)');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '🔄 Generating...';

            try {
                const backendOnline = await checkBackendStatus();
                
                if (backendOnline) {
                    // Detect key variables to help with parsing
                    const detectedVariables = detectKeyVariables(humanExample);
                    
                    const response = await fetch('/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            human_example: humanExample,
                            target_length: parseInt(document.getElementById('targetLength').value),
                            style_preference: document.getElementById('stylePreference').value,
                            document_type: document.getElementById('documentType').value,
                            detected_variables: detectedVariables // Include detected variables for better parsing
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showResults(result);
                    } else {
                        throw new Error('Backend request failed');
                    }
                } else {
                    // Use mock data for demo
                    setTimeout(() => {
                        const mockResult = generateMockResult(humanExample);
                        showResults(mockResult);
                    }, 2000);
                }
            } catch (error) {
                console.error('Generation error:', error);
                setTimeout(() => {
                    const mockResult = generateMockResult(humanExample);
                    showResults(mockResult);
                }, 2000);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '🚀 Generate Legal Template';
            }
        }

        // Generate mock result for demo
        function generateMockResult(humanExample) {
            const mockGenerated = `INFLUENCER MARKETING AGREEMENT

This agreement between [Brand Name] and [Content Creator] establishes the comprehensive terms for a strategic marketing collaboration. The creator agrees to develop authentic content featuring brand products across Instagram platforms. Content deliverables include posts, stories, video content with proper brand attribution and hashtag usage. All content must align with brand guidelines while maintaining the creator's authentic voice and style.

The collaboration period spans 60 days with exclusive content rights during this timeframe. Compensation includes monetary compensation plus product gifting as outlined in the attached rate card. Usage rights extend to brand marketing materials and promotional campaigns with proper creator attribution.

Performance will be measured through comprehensive analytics including engagement rates, reach, impressions, and conversion tracking. Both parties commit to transparent reporting and data sharing to optimize campaign effectiveness and ensure mutual success.

The influencer agrees to maintain exclusivity within the skincare category during the collaboration period and comply with all applicable advertising standards and FTC disclosure requirements. All content must clearly indicate the commercial nature of the partnership through appropriate hashtags and disclosures.

This agreement shall be governed by applicable laws and any disputes shall be resolved through binding arbitration. Both parties acknowledge they have read and understood all terms and conditions outlined herein.`;

            return {
                generated_text: mockGenerated,
                similarity_to_example: 0.87,
                word_count: mockGenerated.split(/\s+/).length,
                processing_time: 1.234,
                generation_metadata: {
                    style_preference: document.getElementById('stylePreference').value,
                    document_type: document.getElementById('documentType').value,
                    reference_templates_used: 3,
                    target_length: parseInt(document.getElementById('targetLength').value),
                    actual_length: mockGenerated.length
                }
            };
        }

        // Show results
        function showResults(result) {
            currentResult = result;
            
            // Update metrics
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric">
                    <div class="metric-value">${result.word_count}</div>
                    <div class="metric-label">Words Generated</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(result.similarity_to_example * 100).toFixed(0)}%</div>
                    <div class="metric-label">Similarity Score</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(result.processing_time * 1000).toFixed(0)}ms</div>
                    <div class="metric-label">Processing Time</div>
                </div>
            `;

            // Show generated text
            document.getElementById('generatedText').textContent = result.generated_text;

            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('errorSection').style.display = 'none';

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Show error
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        }

        // Copy to clipboard
        function copyToClipboard() {
            if (currentResult) {
                navigator.clipboard.writeText(currentResult.generated_text).then(() => {
                    showTemporaryMessage('✅ Text copied to clipboard!', 'success');
                });
            }
        }

        // Download single result as .txt file
        function downloadSingleResult() {
            if (currentResult) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const docType = currentResult.generation_metadata?.document_type || 'legal_template';
                
                const content = `Legal Document Generated by Thinkerbell
==========================================

Document Type: ${currentResult.generation_metadata?.document_type || 'Legal Template'}
Style: ${currentResult.generation_metadata?.style_preference || 'Professional'}
Target Length: ${currentResult.generation_metadata?.target_length || 'N/A'} words
Generated: ${new Date().toLocaleString()}

Original Input:
--------------
${document.getElementById('humanExample').value}

Generated Legal Text:
--------------------
${currentResult.generated_text}

Performance Metrics:
-------------------
Word Count: ${currentResult.word_count}
Similarity Score: ${(currentResult.similarity_to_example * 100).toFixed(1)}%
Processing Time: ${(currentResult.processing_time * 1000).toFixed(0)}ms
Actual Length: ${currentResult.generation_metadata?.actual_length || 'N/A'} characters
`;
                
                downloadText(content, `thinkerbell_${docType}_${timestamp}.txt`);
                showTemporaryMessage('✅ Legal document downloaded as .txt file!', 'success');
            }
        }

        // Test similarity (mock)
        function testSimilarity() {
            const text1 = document.getElementById('text1').value.trim();
            const text2 = document.getElementById('text2').value.trim();
            
            if (!text1 || !text2) {
                document.getElementById('similarityResult').innerHTML = `
                    <div class="error-card">
                        <p>Please enter both texts</p>
                    </div>
                `;
                return;
            }

            // Mock similarity calculation
            const similarity = Math.random() * 0.4 + 0.3;
            const interpretation = similarity > 0.6 ? 'Similar' : similarity > 0.4 ? 'Somewhat similar' : 'Different';
            
            document.getElementById('similarityResult').innerHTML = `
                <div class="result-card" style="margin-top: 20px;">
                    <h4>Similarity Results:</h4>
                    <div class="grid">
                        <div class="metric">
                            <div class="metric-value">${similarity.toFixed(3)}</div>
                            <div class="metric-label">Similarity Score</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${interpretation}</div>
                            <div class="metric-label">Interpretation</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        // Load saved theme preference
        function loadThemePreference() {
            const darkMode = localStorage.getItem('darkMode');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (darkMode === 'enabled') {
                body.classList.add('dark-mode');
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light';
            }
        }

        // Enhanced Menu Functions
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function updateBatchInputCount() {
            const rows = document.querySelectorAll('.batch-input-row');
            const countElement = document.getElementById('batchInputCount');
            if (countElement) {
                countElement.textContent = `${rows.length} input${rows.length !== 1 ? 's' : ''} configured`;
            }
            
            // Update validation status
            const validationStatus = document.getElementById('batchValidationStatus');
            const validationText = document.getElementById('batchValidationText');
            
            let hasValidInputs = false;
            rows.forEach(row => {
                const example = row.querySelector('.batch-human-example').value.trim();
                if (example.length > 10) {
                    hasValidInputs = true;
                }
            });
            
            if (validationStatus && validationText) {
                if (hasValidInputs) {
                    validationStatus.className = 'status-dot';
                    validationText.textContent = 'Ready to process';
                } else {
                    validationStatus.className = 'status-dot warning';
                    validationText.textContent = 'Need valid inputs';
                }
            }
        }

        function updateJobsStats(jobs) {
            const totalCount = document.getElementById('totalJobsCount');
            const completedCount = document.getElementById('completedJobsCount');
            const processingCount = document.getElementById('processingJobsCount');
            
            if (totalCount) totalCount.textContent = `${jobs.length} total jobs`;
            
            const completed = jobs.filter(job => job.status === 'completed').length;
            const processing = jobs.filter(job => job.status === 'processing').length;
            
            if (completedCount) completedCount.textContent = `${completed} completed`;
            if (processingCount) processingCount.textContent = `${processing} processing`;
        }

        function refreshBatchStatus() {
            if (currentBatchId) {
                clearInterval(batchStatusInterval);
                startBatchStatusPolling();
            }
        }

        function exportJobsHistory() {
            fetch('/batch/list')
                .then(response => response.json())
                .then(data => {
                    const exportData = {
                        exported_at: new Date().toISOString(),
                        total_jobs: data.batch_jobs.length,
                        jobs: data.batch_jobs
                    };
                    downloadJSON(exportData, `batch_jobs_history_${new Date().toISOString().split('T')[0]}.json`);
                })
                .catch(error => {
                    console.error('Export error:', error);
                    showTemporaryMessage('Export functionality requires backend connection', 'error');
                });
        }

        // Batch auto-detection functions
        let batchAutoDetectTimeouts = new Map();
        
        function debounceBatchAutoDetect(row, text) {
            // Clear existing timeout for this row
            if (batchAutoDetectTimeouts.has(row)) {
                clearTimeout(batchAutoDetectTimeouts.get(row));
            }
            
            // Set new timeout
            const timeout = setTimeout(() => {
                batchAutoDetectParameters(row, text);
            }, 1000);
            
            batchAutoDetectTimeouts.set(row, timeout);
        }
        
        async function batchAutoDetectParameters(row, text) {
            if (!text || text.length < 50) return;
            
            try {
                const backendOnline = await checkBackendStatus();
                let result;
                
                if (backendOnline) {
                    const response = await fetch('/auto-detect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: text })
                    });

                    if (response.ok) {
                        result = await response.json();
                    } else {
                        result = fallbackAutoDetect(text);
                    }
                } else {
                    result = fallbackAutoDetect(text);
                }
                
                // Update the batch row with detected parameters
                updateBatchRowParameters(row, result);
                
            } catch (error) {
                console.error('Batch auto-detection error:', error);
                const result = fallbackAutoDetect(text);
                updateBatchRowParameters(row, result);
            }
        }
        
        function updateBatchRowParameters(row, result) {
            // Update the select elements in this specific row
            row.querySelector('.batch-target-length').value = result.target_length;
            row.querySelector('.batch-style').value = result.style_preference;
            row.querySelector('.batch-document-type').value = result.document_type;
            
            // Add visual indicator that auto-detection occurred
            const textarea = row.querySelector('.batch-human-example');
            const confidence = result.confidence_scores?.overall || 0.6;
            const confidencePercent = Math.round(confidence * 100);
            
            // Create or update indicator
            let indicator = row.querySelector('.auto-detect-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'auto-detect-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background: rgba(16, 185, 129, 0.9);
                    color: white;
                    padding: 2px 6px;
                    border-radius: 10px;
                    font-size: 0.7rem;
                    font-weight: 600;
                    z-index: 10;
                `;
                
                // Make the row position relative if it isn't already
                if (getComputedStyle(row).position === 'static') {
                    row.style.position = 'relative';
                }
                
                row.appendChild(indicator);
            }
            
            indicator.textContent = `🤖 ${confidencePercent}%`;
            indicator.title = `Auto-detected: ${result.document_type.replace('_', ' ')}, ${result.style_preference}, ${result.target_length} words`;
            
            // Fade out after 3 seconds
            setTimeout(() => {
                if (indicator) {
                    indicator.style.opacity = '0.6';
                }
            }, 3000);
        }

        // Batch Processing Functions
        function addBatchInput() {
            const batchInputs = document.getElementById('batchInputs');
            const newRow = document.createElement('div');
            newRow.className = 'batch-input-row';
            newRow.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Human Example:</label>
                    <div class="cache-history-container">
                        <textarea class="form-textarea batch-human-example" placeholder="Enter legal text example..."></textarea>
                        <div class="cache-indicator batch-cache-indicator"></div>
                        <button class="cache-recovery-btn batch-recovery-btn" onclick="toggleBatchCacheHistory(this)" disabled>
                            📝 History
                        </button>
                        <div class="cache-history-dropdown batch-cache-dropdown">
                            <div class="cache-history-header">
                                <span>📝 Text History</span>
                                <button class="cache-clear-all" onclick="clearBatchCacheHistory(this)">Clear All</button>
                            </div>
                            <div class="cache-history-list batch-cache-list">
                                <div class="cache-empty-state">No saved text history yet</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Target Length:</label>
                    <select class="form-select batch-target-length">
                        <option value="500">Short (500)</option>
                        <option value="700" selected>Medium (700)</option>
                        <option value="1000">Long (1000)</option>
                        <option value="1200">Comprehensive (1200)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Style:</label>
                    <select class="form-select batch-style">
                        <option value="professional" selected>Professional</option>
                        <option value="formal">Formal</option>
                        <option value="business">Business</option>
                        <option value="detailed">Detailed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Document Type:</label>
                    <select class="form-select batch-document-type">
                        <option value="legal_template" selected>Legal Template</option>
                        <option value="influencer_agreement">Influencer Agreement</option>
                        <option value="brand_partnership">Brand Partnership</option>
                        <option value="content_creation">Content Creation</option>
                        <option value="marketing_agreement">Marketing Agreement</option>
                    </select>
                </div>
                <button class="remove-btn" onclick="removeBatchInput(this)">Remove</button>
            `;
            batchInputs.appendChild(newRow);
            updateRemoveButtons();
            updateBatchInputCount();
            
            // Add event listeners to new inputs for real-time validation and auto-detection
            const newTextarea = newRow.querySelector('.batch-human-example');
            
            // Assign unique cache ID for this batch input
            const cacheId = 'batch_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            newTextarea.dataset.cacheId = cacheId;
            
            newTextarea.addEventListener('input', function() {
                updateBatchInputCount();
                
                // Auto-detect parameters for this specific row
                if (this.value.length > 50) {
                    debounceBatchAutoDetect(newRow, this.value);
                }
                
                // Handle batch cache
                handleBatchCacheInput(newRow, this.value);
            });
            
            newTextarea.addEventListener('paste', function() {
                setTimeout(() => {
                    handleBatchCacheInput(newRow, this.value);
                }, 100);
            });
            
            // Initialize cache UI for this batch input
            updateBatchCacheUI(newRow, newTextarea, newRow.querySelector('.batch-cache-list'));
        }

        function removeBatchInput(button) {
            button.closest('.batch-input-row').remove();
            updateRemoveButtons();
            updateBatchInputCount();
        }

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.batch-input-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-btn');
                if (rows.length > 1) {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }

        function loadBatchSampleData() {
            // Clear existing inputs
            document.getElementById('batchInputs').innerHTML = '';
            
            const sampleData = [
                {
                    human_example: "I need a contract for working with an Instagram influencer. They will post about our skincare products twice a week for 2 months. We'll pay them $2000 plus send free products.",
                    target_length: 700,
                    style_preference: "professional",
                    document_type: "influencer_agreement"
                },
                {
                    human_example: "We want to partner with a food blogger to create recipe content featuring our organic ingredients. They'll make 4 videos per month for 6 months.",
                    target_length: 1000,
                    style_preference: "business",
                    document_type: "content_creation"
                }
            ];

            sampleData.forEach((data, index) => {
                if (index > 0) addBatchInput();
                
                const rows = document.querySelectorAll('.batch-input-row');
                const currentRow = rows[index];
                
                currentRow.querySelector('.batch-human-example').value = data.human_example;
                currentRow.querySelector('.batch-target-length').value = data.target_length;
                currentRow.querySelector('.batch-style').value = data.style_preference;
                currentRow.querySelector('.batch-document-type').value = data.document_type;
                
                // Add event listener for validation and auto-detection
                const textarea = currentRow.querySelector('.batch-human-example');
                textarea.addEventListener('input', function() {
                    updateBatchInputCount();
                    
                    // Auto-detect parameters for this row
                    if (this.value.length > 50) {
                        debounceBatchAutoDetect(currentRow, this.value);
                    }
                });
                
                // Trigger auto-detection for the sample data
                if (data.human_example.length > 50) {
                    setTimeout(() => {
                        batchAutoDetectParameters(currentRow, data.human_example);
                    }, 500 * index); // Stagger the requests
                }
            });
            
            updateBatchInputCount();
        }

        async function startBatchProcessing() {
            const batchName = document.getElementById('batchName').value.trim() || 'Unnamed Batch';
            const rows = document.querySelectorAll('.batch-input-row');
            
            const batchInputs = [];
            let hasErrors = false;
            
            rows.forEach((row, index) => {
                const humanExample = row.querySelector('.batch-human-example').value.trim();
                if (!humanExample) {
                    showTemporaryMessage(`Please fill in the human example for input ${index + 1}`, 'error');
                    hasErrors = true;
                    return;
                }
                
                batchInputs.push({
                    human_example: humanExample,
                    target_length: parseInt(row.querySelector('.batch-target-length').value),
                    style_preference: row.querySelector('.batch-style').value,
                    document_type: row.querySelector('.batch-document-type').value
                });
            });
            
            if (hasErrors || batchInputs.length === 0) {
                return;
            }

            const processBtn = document.getElementById('batchProcessBtn');
            processBtn.disabled = true;
            processBtn.textContent = '🔄 Starting Batch...';

            try {
                const backendOnline = await checkBackendStatus();
                
                if (backendOnline) {
                    const response = await fetch('/batch/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            batch_inputs: batchInputs,
                            batch_name: batchName
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        currentBatchId = result.batch_id;
                        showBatchStatus();
                        startBatchStatusPolling();
                    } else {
                        throw new Error('Failed to start batch processing');
                    }
                } else {
                    // Mock batch processing
                    currentBatchId = 'mock-' + Date.now();
                    showMockBatchProcessing(batchInputs, batchName);
                }
            } catch (error) {
                console.error('Batch processing error:', error);
                showTemporaryMessage('Failed to start batch processing: ' + error.message, 'error');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = '🚀 Start Batch Processing';
            }
        }

        function showBatchStatus() {
            document.getElementById('batchStatusSection').style.display = 'block';
            document.getElementById('batchStatusSection').scrollIntoView({ behavior: 'smooth' });
        }

        function startBatchStatusPolling() {
            if (batchStatusInterval) {
                clearInterval(batchStatusInterval);
            }
            
            batchStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/batch/status/${currentBatchId}`);
                    if (response.ok) {
                        const status = await response.json();
                        updateBatchStatusDisplay(status);
                        
                        if (status.status === 'completed' || status.status === 'failed') {
                            clearInterval(batchStatusInterval);
                            refreshBatchJobs();
                        }
                    }
                } catch (error) {
                    console.error('Error polling batch status:', error);
                }
            }, 2000);
        }

        function updateBatchStatusDisplay(status) {
            const statusContent = document.getElementById('batchStatusContent');
            const progressPercent = (status.completed_items / status.total_items) * 100;
            
            let statusClass = 'processing';
            let statusIcon = '🔄';
            let statusText = 'Processing';
            
            if (status.status === 'completed') {
                statusClass = 'completed';
                statusIcon = '✅';
                statusText = 'Completed';
            } else if (status.status === 'failed') {
                statusClass = 'failed';
                statusIcon = '❌';
                statusText = 'Failed';
            }
            
            statusContent.innerHTML = `
                <div class="batch-status ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>${statusIcon} ${statusText}</h4>
                        <div>
                            <strong>${status.completed_items}/${status.total_items}</strong> items processed
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 0.9rem; color: #64748b;">
                        Batch ID: ${status.batch_id}<br>
                        Started: ${new Date(status.created_at).toLocaleString()}
                        ${status.completed_at ? `<br>Completed: ${new Date(status.completed_at).toLocaleString()}` : ''}
                    </div>
                    
                    ${status.status === 'completed' ? `
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn success" onclick="downloadBatchResults('${status.batch_id}')">
                                📦 Download ZIP Results
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showMockBatchProcessing(batchInputs, batchName) {
            const mockBatchId = currentBatchId;
            let completed = 0;
            
            const mockStatus = {
                batch_id: mockBatchId,
                status: 'processing',
                total_items: batchInputs.length,
                completed_items: 0,
                created_at: new Date().toISOString(),
                batch_name: batchName
            };
            
            showBatchStatus();
            updateBatchStatusDisplay(mockStatus);
            
            const mockInterval = setInterval(() => {
                completed++;
                mockStatus.completed_items = completed;
                
                if (completed >= batchInputs.length) {
                    mockStatus.status = 'completed';
                    mockStatus.completed_at = new Date().toISOString();
                    clearInterval(mockInterval);
                    refreshBatchJobs();
                }
                
                updateBatchStatusDisplay(mockStatus);
            }, 2000);
        }

        async function refreshBatchJobs() {
            try {
                const response = await fetch('/batch/list');
                if (response.ok) {
                    const data = await response.json();
                    displayBatchJobs(data.batch_jobs);
                } else {
                    displayBatchJobs([]);
                }
            } catch (error) {
                console.error('Error refreshing batch jobs:', error);
                displayBatchJobs([]);
            }
        }

        function displayBatchJobs(jobs) {
            const jobsList = document.getElementById('batchJobsList');
            
            // Update stats
            updateJobsStats(jobs);
            
            if (jobs.length === 0) {
                jobsList.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px;">No batch jobs found. Start your first batch processing above!</div>';
                return;
            }
            
            jobsList.innerHTML = jobs.map(job => {
                let statusIcon = '🔄';
                
                if (job.status === 'completed') {
                    statusIcon = '✅';
                } else if (job.status === 'failed') {
                    statusIcon = '❌';
                }
                
                return `
                    <div class="batch-job-item">
                        <div class="batch-job-info">
                            <div style="font-weight: 600; margin-bottom: 5px;">
                                ${statusIcon} ${job.batch_name}
                            </div>
                            <div style="font-size: 0.9rem; color: #64748b;">
                                ${job.completed_items}/${job.total_items} items • 
                                Created: ${new Date(job.created_at).toLocaleString()}
                                ${job.completed_at ? ` • Completed: ${new Date(job.completed_at).toLocaleString()}` : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 2px;">
                                ID: ${job.batch_id}
                            </div>
                        </div>
                        <div class="batch-job-actions">
                            ${job.status === 'completed' ? `
                                <button class="btn success" onclick="downloadBatchResults('${job.batch_id}')">
                                    📦 Download ZIP
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function downloadBatchResults(batchId) {
            try {
                const response = await fetch(`/batch/download/${batchId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // Extract filename from response headers or create default
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = `thinkerbell_batch_${batchId}.zip`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showTemporaryMessage('✅ Batch results ZIP downloaded!', 'success');
                } else {
                    showTemporaryMessage('Download not available - backend offline', 'error');
                }
            } catch (error) {
                console.error('Error downloading batch results:', error);
                showTemporaryMessage('Failed to download batch results', 'error');
            }
        }

        // Utility function to download JSON
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Utility function to download text files
        function downloadText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Show temporary message function
        function showTemporaryMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            `;
            
            // Add animation keyframes if not already added
            if (!document.querySelector('#temp-message-styles')) {
                const style = document.createElement('style');
                style.id = 'temp-message-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadThemePreference();
            checkBackendStatus();
            updateRemoveButtons();
            updateBatchInputCount();
            
            // Initialize cache history manager
            cacheHistoryManager = new CacheHistoryManager();
            
            // Add event listeners to existing batch inputs
            document.querySelectorAll('.batch-human-example').forEach((textarea, index) => {
                // Assign unique cache ID for existing batch inputs
                const cacheId = 'batch_initial_' + index;
                textarea.dataset.cacheId = cacheId;
                
                textarea.addEventListener('input', function() {
                    updateBatchInputCount();
                    
                    // Auto-detect parameters for this row
                    if (this.value.length > 50) {
                        const row = this.closest('.batch-input-row');
                        debounceBatchAutoDetect(row, this.value);
                    }
                    
                    // Handle batch cache
                    const row = this.closest('.batch-input-row');
                    handleBatchCacheInput(row, this.value);
                });
                
                textarea.addEventListener('paste', function() {
                    setTimeout(() => {
                        const row = this.closest('.batch-input-row');
                        handleBatchCacheInput(row, this.value);
                    }, 100);
                });
                
                // Initialize cache UI for existing batch inputs
                const row = textarea.closest('.batch-input-row');
                updateBatchCacheUI(row, textarea, row.querySelector('.batch-cache-list'));
            });
        });
    </script>

    <div class="footer">
        <div class="awards">
            <strong>2025 ADNEWS Independent Agency of the Year</strong><br>
            <strong>2024 ADNEWS PR Agency of the Year</strong><br>
            2023 B&T Advertising Agency of the Year • 2022 MUMBRELLA Full Service Agency of the Year
        </div>
        <div class="philosophy">
            "Where scientific enquiry meets hardcore creativity – Measured Magic"
        </div>
        <div style="margin-top: 20px; font-size: 0.8rem;">
            © 2025 Thinkerbell Enhanced Legal Text Generator
        </div>
    </div>
</body>
</html>
